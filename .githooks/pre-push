#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

current_branch="$(git rev-parse --abbrev-ref HEAD)"
if [[ "$current_branch" == "main" && "${RFX_ALLOW_MAIN_PUSH:-0}" != "1" ]]; then
  echo "Direct pushes to 'main' are blocked."
  echo "Push your branch and open a PR into main."
  echo "Set RFX_ALLOW_MAIN_PUSH=1 to override intentionally."
  exit 1
fi

require_cmd() {
  local tool="$1"
  if ! command -v "$tool" >/dev/null 2>&1; then
    echo "Missing required command: $tool" >&2
    exit 1
  fi
}

require_cmd cargo
require_cmd bash

# Keep PyO3 builds stable across local Python versions.
if [[ -x "$ROOT/.venv/bin/python" ]]; then
  export PYO3_PYTHON="$ROOT/.venv/bin/python"
fi
export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1

echo "[pre-push] cargo fmt --all -- --check"
cargo fmt --all -- --check

echo "[pre-push] cargo clippy --workspace --all-targets --all-features"
cargo clippy --workspace --all-targets --all-features

echo "[pre-push] cargo test --workspace --all-features"
cargo test --workspace --all-features

echo "[pre-push] python lint + typecheck + tests"
"$ROOT/scripts/python-checks.sh" ci

echo "[pre-push] all checks passed"
