name: Publish Python Packages

on:
  workflow_dispatch:
    inputs:
      index:
        description: "Target index"
        required: true
        type: choice
        options:
          - testpypi
          - pypi
        default: testpypi
      dry_run:
        description: "Run publish in dry-run mode"
        required: true
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-core-wheels:
    name: Build core wheel (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Linux build deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libudev-dev

      - name: Build core wheel
        run: uv build --wheel --out-dir dist

      - name: Upload core wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: core-wheel-${{ matrix.os }}
          path: dist/*.whl
          if-no-files-found: error

  build-sdists-and-pure:
    name: Build sdists + pure packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Build sdists and pure package artifacts
        run: |
          uv build --sdist --out-dir dist
          uv build packages/rfx-sim --out-dir dist
          uv build packages/rfx-go2 --out-dir dist
          uv build packages/rfx-lerobot --out-dir dist

      - name: Upload source/pure artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-and-pure
          path: |
            dist/*.tar.gz
            dist/rfx_sdk_sim-*.whl
            dist/rfx_sdk_go2-*.whl
            dist/rfx_sdk_lerobot-*.whl
          if-no-files-found: error

  publish:
    name: Publish to ${{ inputs.index }}
    runs-on: ubuntu-latest
    needs: [build-core-wheels, build-sdists-and-pure]
    permissions:
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Publish artifacts
        env:
          TEST_PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          shopt -s nullglob
          files=(dist/*)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No artifacts found in dist/"
            exit 1
          fi

          if [ "${{ inputs.index }}" = "testpypi" ]; then
            export UV_PUBLISH_TOKEN="${TEST_PYPI_TOKEN}"
            export UV_PUBLISH_URL="https://test.pypi.org/legacy/"
            export UV_PUBLISH_CHECK_URL="https://test.pypi.org/simple/"
          else
            export UV_PUBLISH_TOKEN="${PYPI_TOKEN}"
            export UV_PUBLISH_URL="https://upload.pypi.org/legacy/"
            export UV_PUBLISH_CHECK_URL="https://pypi.org/simple/"
          fi

          if [ -z "${UV_PUBLISH_TOKEN}" ]; then
            echo "Missing token secret for target index."
            exit 1
          fi

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            uv publish --dry-run dist/*
          else
            uv publish dist/*
          fi
